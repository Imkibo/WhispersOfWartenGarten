<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kakteenschlacht</title>
    <style>
      /* Dein originales CSS bleibt unver√§ndert */
      body {
        background-color: #90a2bb;
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      #score {
        font-family: "Courier New", monospace;
        font-size: 150px;
        color: #39ed39;
        margin-bottom: 20px;
        z-index: 2;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("img/hintergrund.png");
        background-size: cover;
        z-index: -1;
      }

      canvas {
        background-color: #39ed39;
        border-radius: 320px / 270px;
        display: block;
        width: 100%;
        max-width: 850px;
        height: auto;
      }

      /* Wurmspeicher Styling */
      #worm-storage {
        position: absolute;
        bottom: 20px;
        left: 30%;
        transform: translateX(-50%);
        width: 150px;
        height: 150px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 3;
      }

      /* Audio Player Styling */
      audio {
        width: 300px;
        height: 40px;
        background: black;
        border-radius: 10px;
        display: block;
        margin-top: 20px;
      }

      audio::-webkit-media-controls-panel {
        background: #90a2bb;
      }

      /* Responsive Anpassungen bleiben wie gehabt */
      @media (max-width: 900px) {
        body {
          background-color: black;
        }
        body::before {
          content: "";
          background-color: black;
        }
        #score {
          font-size: 50px;
          color: red;
        }
        canvas {
          max-width: 100%;
          height: auto;
        }
        #instructions-box {
          position: relative;
          margin-top: 20px;
          width: 100%;
          max-width: 850px;
          background-color: black;
          color: white;
          font-family: "Courier New", monospace;
          font-size: 1.1rem;
          padding: 10px;
          box-sizing: border-box;
          overflow-y: auto;
          z-index: 2;
        }
      }

      @media (min-width: 769px) {
        #instructions-box {
          position: absolute;
          left: 0;
          top: 65%;
          width: 26%;
          height: 35%;
          border-top-right-radius: 100px;
          background-color: rgba(0, 0, 0, 100);
          color: white;
          font-family: "Courier New", monospace;
          font-size: 1.2rem;
          padding: 20px;
          box-sizing: border-box;
          overflow-y: auto;
          z-index: 2;
        }
        #score {
          font-size: 150px;
        }
        canvas {
          width: 850px;
          height: 600px;
        }
      }
      #next-section {
        margin-top: 30px;
        font-family: "Courier New", monospace;
      }
      #next-section h2 {
        font-size: 30px;
        color: #39ed39;
      }
      #next-section p {
        font-size: 18px;
        color: white;
      }
      #next-section a {
        font-size: 30px;
        font-weight: bold;
        color: #90a2bb;
        text-decoration: none;
      }
      #next-section a:hover {
        color: #39ed39;
      }
      #stats-box {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: black;
        color: white;
        font-family: "Courier New", monospace;
        font-size: 18px;
        padding: 10px 15px;
        border-radius: 5px;
        text-align: right;
        z-index: 10;
      }
    </style>
    <script>
      let KEY_SPACE = false;
      let KEY_UP = false;
      let KEY_DOWN = false;
      let paused = false; // Neue Variable f√ºr Pausenfunktion

      let canvas;
      let ctx;
      const backgroundImage = new Image();

      let imke = {
        x: 50,
        y: 250,
        width: 60,
        height: 100,
        src: "img/imke.png",
        image: new Image(),
      };
      imke.image.src = imke.src;

      let feiges = [];
      let wurms = [];
      let score = 0;
      let feigeInterval = 5000;
      let feigeIntervalID;
      let feigeGrowthRate = 20;
      let feigeSizeThreshold = 10;
      let feigeCounter = 0;

      // Wurmspeicher Variablen
      let wormStorage = {
        currentWorms: 0,
        maxWorms: 10,
        wormTimer: Date.now(),
      };

      // üîπ **NEUE VARIABLEN f√ºr Statistik**
      let wormsShot = 0;
      let cactusHit = 0;
      let highscore = localStorage.getItem("highscore") || 0;
      let startTime = Date.now();

      // Sounds laden
      let soundFeigeHit = new Audio("sounds/autsch.mp3");
      let soundImkeBoom = new Audio("sounds/explode.mp3");
      let soundWurmShoot = new Audio("sounds/wurmflutsch.mp3");
      let soundBackground = new Audio("sounds/Kaktusschlacht.mp3");
      let soundSlip = new Audio("sounds/ausrutsch.mp3");

      // Hintergrundmusik im Loop abspielen
      soundBackground.loop = true;
      soundBackground.volume = 0.5;
      soundBackground.play();

      function updateScore() {
        document.getElementById("score").innerText = "Punkte: " + score;
        document.getElementById("cactus-hit").innerText = cactusHit;
        document.getElementById("worms-shot").innerText = wormsShot;

        if (score > highscore) {
          highscore = score;
          localStorage.setItem("highscore", highscore);
        }
        document.getElementById("highscore").innerText = highscore;
      }

      function updateTime() {
        let elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("time-passed").innerText = elapsedTime;
      }
      setInterval(updateTime, 1000);

      document.onkeydown = function (e) {
        if (e.keyCode === 32) KEY_SPACE = true;
        if (e.keyCode === 38) KEY_UP = true;
        if (e.keyCode === 40) KEY_DOWN = true;
        if (e.key === "s") paused = true;
        if (e.key === "p") paused = false;
      };

      document.onkeyup = function (e) {
        if (e.keyCode === 32) KEY_SPACE = false;
        if (e.keyCode === 38) KEY_UP = false;
        if (e.keyCode === 40) KEY_DOWN = false;
      };

      function startGame() {
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        loadImages();

        // Spiel-Schleife starten
        setInterval(update, 1000 / 25); // 25 FPS f√ºr die Hauptlogik
        feigeIntervalID = setInterval(createfeiges, feigeInterval);
        setInterval(checkForCollision, 1000 / 25); // √úberpr√ºfen auf Kollisionen

        // Highscore jede Millisekunde √ºberpr√ºfen
        setInterval(updateScore, 1); // Hier wird der Highscore alle 1ms aktualisiert

        draw();
        updateScore();
        setInterval(updateWormStorage, 1000);
      }

      function isCollision(obj1, obj2) {
        return (
          obj1.x + obj1.width > obj2.x &&
          obj1.y + obj1.height > obj2.y &&
          obj1.x < obj2.x + obj2.width &&
          obj1.y < obj2.y + obj2.height
        );
      }

      function checkForCollision() {
        feiges.forEach((feige, index) => {
          if (isCollision(imke, feige)) {
            imke.image.src = "img/boom.png";
            soundImkeBoom.play();
            setTimeout(() => {
              location.reload();
            }, 1000);
          }

          wurms.forEach((wurm) => {
            if (isCollision(wurm, feige) && !feige.hit) {
              feige.hit = true;
              feige.img.src = "img/dreck.png";
              soundFeigeHit.play();
              score++;
              cactusHit++; // üîπ **Kaktus-Treffer z√§hlen**
              updateScore();

              setTimeout(() => {
                feiges.splice(index, 1);
              }, 500);
            }
          });
        });
      }

      function createfeiges() {
        let feige = {
          x: canvas.width,
          y: Math.random() * (canvas.height - 100),
          width: 100,
          height: 80,
          src: "img/feige.png",
          img: new Image(),
          hit: false,
          initialWidth: 100,
          initialHeight: 80,
          growTime: Date.now(),
        };
        feige.img.src = feige.src;
        feiges.push(feige);

        let elapsedTime = Date.now() - feigeInterval;
        if (elapsedTime > 20000 && feigeInterval > 1000) {
          feigeInterval -= 200;
          clearInterval(feigeIntervalID);
          feigeIntervalID = setInterval(createfeiges, feigeInterval);
        }
      }

      function updateWormStorage() {
        if (Date.now() - wormStorage.wormTimer > 5000) {
          wormStorage.wormTimer = Date.now();
          wormStorage.currentWorms = 0;
        }

        if (wormStorage.currentWorms >= 10) {
          document.getElementById("worm-storage").style.backgroundImage =
            "url('img/topf3.png')";
        } else if (wormStorage.currentWorms >= 5) {
          document.getElementById("worm-storage").style.backgroundImage =
            "url('img/topf2.png')";
        } else {
          document.getElementById("worm-storage").style.backgroundImage =
            "url('img/topf1.png')";
        }
      }

      function update() {
        if (paused) return;

        if (KEY_SPACE) {
          if (wormStorage.currentWorms < wormStorage.maxWorms) {
            let wurm = {
              x: imke.x + imke.width - 30,
              y: imke.y + imke.height / 2 - 2,
              width: 20,
              height: 20,
              src: "img/wurm.png",
              img: new Image(),
            };
            wurm.img.src = wurm.src;
            wurms.push(wurm);
            wormStorage.currentWorms++;
            wormsShot++; // üîπ **W√ºrmer-Z√§hler erh√∂hen**
            soundWurmShoot.play();
          }
        }

        if (KEY_UP && imke.y > 0) imke.y -= 8;
        if (KEY_DOWN && imke.y + imke.height < canvas.height) imke.y += 8;

        feiges.forEach((feige) => {
          if (score >= feigeSizeThreshold && !feige.hit) {
            let elapsedTime = Date.now() - feige.growTime;
            if (elapsedTime >= 500) {
              if (feigeCounter % 3 == 0) {
                feige.width *= 1 + feigeGrowthRate / 100;
                feige.height *= 1 + feigeGrowthRate / 100;
              }
              feige.growTime = Date.now();
              feigeCounter++;
            }
          }
          feige.x -= 5;
        });

        wurms.forEach((wurm) => (wurm.x += 10));
        wurms = wurms.filter((wurm) => wurm.x < canvas.width);

        draw();
      }

      function loadImages() {
        backgroundImage.src = "img/p_background.png";
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
        ctx.drawImage(imke.image, imke.x, imke.y, imke.width, imke.height);
        feiges.forEach((feige) => {
          ctx.drawImage(feige.img, feige.x, feige.y, feige.width, feige.height);
        });

        wurms.forEach((wurm) => {
          ctx.drawImage(wurm.img, wurm.x, wurm.y, wurm.width, wurm.height);
        });
      }

      window.onload = startGame;
    </script>
  </head>
  <body>
    <div id="stats-box">
      <p>W√ºrmer: <span id="worms-shot">0</span></p>
      <p>Kakteen getroffen: <span id="cactus-hit">0</span></p>
      <p>Highscore: <span id="highscore">0</span></p>
      <p>Zeit: <span id="time-passed">0</span>s</p>
    </div>
    <div id="score">Punkte: 0</div>
    <canvas id="canvas" width="850" height="600"></canvas>
    <div id="worm-storage"></div>
    <div id="instructions-box">
      <b>Anleitung & Steuerung: </b><br />
      Steuere Imke: [‚Üë] [‚Üì] <br />
      Schie√üe Raupen: [SPACE]<br />
      Pausieren: [s]<br />
      Fortsetzen: [p]
      <br /><br />
      Der invasive Feigenkaktus (Opuntia ficus-indica) ist los und verdr√§ngt die
      heimische Flora. Hungrige Larven der Kaktusmotte (Cactoblastis cactorum)
      k√∂nnen die Verbreitung stoppen. Obacht: Schie√üe nicht gleich alles auf
      einmal, dein Wurmvorrat ist begrenzt. Bewege dich mit den Pfeiltasten und
      schie√üe Raupen, um die Feigenkakteen zu bek√§mpfen. Aber pass auf, dass
      dich die Kakteen nicht stechen oder du auf ihrem Dreck ausrutschst!
    </div>
    <section id="next-section">
      <a href="Quiz.html">R√ÑTSELN >>></a>
    </section>
    <audio controls autoplay loop>
      <source src="sounds/Kaktusschlacht.mp3" type="audio/mp3" />
      Dein Browser unterst√ºtzt den Audio-Tag nicht.
    </audio>
  </body>
</html>
